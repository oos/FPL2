<!DOCTYPE html>
<html>
<head>
  <title>Squad Live - FPLove</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <style>
    body{background:#f8f9fa}
    .card{box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter {
      margin-bottom: 10px;
    }
    .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate {
      margin-top: 10px;
    }
  </style>
</head>
<body class="p-4">
  {% include '_navbar.html' %}

  <div class="container mt-4">
    {% if not profile %}
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> No FPL Team Configured</h5>
            <p>You need to add your FPL Team ID in the <a href="/account">Account</a> page first.</p>
            <a href="/account" class="btn btn-primary">Go to Account</a>
        </div>
    {% else %}
        <!-- Team Info Header and Squad Summary for Current GW -->
        <div class="row mb-4">
            <div class="col-md-8">
                <!-- Squad Summary Panel - Will be dynamically updated based on selected GW -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Squad Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h6 class="text-primary">Formation</h6>
                                <h5 class="mb-0" id="topSquadFormation">
                                    {% if squad %}
                                        {{ squad|selectattr('is_bench', 'equalto', false)|selectattr('position', 'equalto', 'Goalkeeper')|list|length }}-{{ squad|selectattr('is_bench', 'equalto', false)|selectattr('position', 'equalto', 'Defender')|list|length }}-{{ squad|selectattr('is_bench', 'equalto', false)|selectattr('position', 'equalto', 'Midfielder')|list|length }}-{{ squad|selectattr('is_bench', 'equalto', false)|selectattr('position', 'equalto', 'Forward')|list|length }}
                                    {% else %}
                                        0-0-0-0
                                    {% endif %}
                                </h5>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-success">Squad Value</h6>
                                <h5 class="mb-0" id="topSquadValue">£{{ "%.1f"|format(squad|sum(attribute='price') if squad else 0) }}M</h5>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-info">Transfers</h6>
                                <h5 class="mb-0" id="topSquadTransfers">0 IN, 0 OUT</h5>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-warning">Hits</h6>
                                <h5 class="mb-0" id="topSquadHits">0 points</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-12">
                                <h3 class="mb-1">{{ profile.team_name or 'My Team' }}</h3>
                                <p class="text-muted mb-0">Manager: {{ profile.manager_name or 'Unknown' }}</p>
                                <p class="text-muted mb-0">FPL Team ID: {{ profile.fpl_team_id }}</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary w-100" id="syncSquadDataBtn">
                                        <i class="fas fa-sync-alt"></i> Sync Squad Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Squad Table -->
        {% if squad %}
        <!-- Weekly Tabs with GW navigation -->
        <div class="d-flex align-items-center mb-2 flex-wrap" style="gap:8px;">
            <div class="btn-group" role="group" aria-label="GW navigation">
                <button class="btn btn-outline-secondary" id="prevGw" title="Previous GW"><i class="fas fa-chevron-left"></i></button>
                <button class="btn btn-outline-secondary" id="nextGw" title="Next GW"><i class="fas fa-chevron-right"></i></button>
            </div>
            <ul class="nav nav-tabs ms-2" id="gwTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="gw1-tab" data-bs-toggle="tab" data-bs-target="#gw1" type="button" role="tab" data-gw="1">
                        GW1
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw2-tab" data-bs-toggle="tab" data-bs-target="#gw2" type="button" role="tab" data-gw="2">
                        GW2
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw3-tab" data-bs-toggle="tab" data-bs-target="#gw3" type="button" role="tab" data-gw="3">
                        GW3
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw4-tab" data-bs-toggle="tab" data-bs-target="#gw4" type="button" role="tab" data-gw="4">
                        GW4
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw5-tab" data-bs-toggle="tab" data-bs-target="#gw5" type="button" role="tab" data-gw="5">
                        GW5
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw6-tab" data-bs-toggle="tab" data-bs-target="#gw6" type="button" role="tab" data-gw="6">
                        GW6
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw7-tab" data-bs-toggle="tab" data-bs-target="#gw7" type="button" role="tab" data-gw="7">
                        GW7
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw8-tab" data-bs-toggle="tab" data-bs-target="#gw8" type="button" role="tab" data-gw="8">
                        GW8
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="gw9-tab" data-bs-toggle="tab" data-bs-target="#gw9" type="button" role="tab" data-gw="9">
                        GW9
                    </button>
                </li>
            </ul>
            
            <!-- Transfer Limit Control - Moved to the right -->
            <div class="d-flex align-items-center ms-auto">
                <label for="maxTransfers" class="form-label mb-0 me-2 text-muted small">Max Transfers/GW:</label>
                <select class="form-select form-select-sm" id="maxTransfers" style="width: 80px;">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <button class="btn btn-primary btn-sm ms-2" id="applyTransfers" onclick="applyTransferLimit()">
                    <i class="fas fa-sync-alt"></i> Apply
                </button>
            </div>
        </div>
        
        <!-- Weekly Content -->
        <div class="tab-content" id="gwTabContent">
            <div class="tab-pane fade show active" id="gw1" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users"></i> GW1 - Your Actual FPL Squad 
                            <span class="badge bg-info ms-2">Historical</span>
                        </h5>
                        <div class="search-field">
                            <input type="search" class="form-control form-control-sm" id="gw1Search" placeholder="Search players..." style="width: 200px;">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="gw1Table">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Name</th>
                                        <th>Team</th>
                                        <th>Price</th>
                                        <th>GW1 xP</th>
                                        <th>GW1 Actual</th>
                                        <th>Diff</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if weekly_data %}
                                        {% for gw_data in weekly_data %}
                                            {% if gw_data.gw == 1 %}
                                                {% for player in gw_data.starting_xi %}
                                        <tr class="{% if player.is_bench %}table-secondary{% endif %}">
                                            <td>
                                                <span class="badge bg-primary">{{ player.position }}</span>
                                            </td>
                                            <td>
                                                <strong>{{ player.web_name }}</strong>
                                                {% if player.is_captain %}
                                                    <span class="badge bg-warning ms-1">C</span>
                                                {% endif %}
                                                {% if player.is_vice_captain %}
                                                    <span class="badge bg-info ms-1">V</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ player.team }}</td>
                                            <td>£{{ "%.1f"|format(player.price) }}M</td>
                                            <td>{{ "%.1f"|format(player.gw1_xp or 0) }}</td>
                                            <td>{{ "%.1f"|format((player.actual_points|float) if player.actual_points else 0) }}</td>
                                            <td class="{% if (player.actual_points|float) > (player.gw1_points|float) %}text-success{% elif (player.actual_points|float) < (player.gw1_points|float) %}text-danger{% endif %}">
                                                {{ "%.1f"|format((player.actual_points|float) - (player.gw1_points|float)) }}
                                            </td>
                                            <td>
                                                {% if player.is_bench %}
                                                    <span class="badge bg-secondary">Bench {{ player.bench_position }}</span>
                                                {% else %}
                                                    <span class="badge bg-success">Starting XI</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if player.transfer_in %}
                                                    <span class="badge bg-success">IN</span>
                                                {% endif %}
                                                {% if player.transfer_out %}
                                                    <span class="badge bg-danger">OUT</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="9" class="text-center text-muted">No squad data available</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Transfer Details Panel for GW1 -->
                {% if weekly_data %}
                    {% for gw_data in weekly_data %}
                        {% if gw_data.gw == 1 %}
                            {% set transfers_in_count = gw_data.starting_xi|length %}
                            {% set transfers_out_count = 0 %}
                {% if transfers_in_count > 0 %}
                <div class="card shadow-sm mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-users"></i> Initial Squad Selection</h6>
                    </div>
                    <div class="card-body">
                        {% if transfers_out_count > 0 %}
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-danger mb-2"><i class="fas fa-arrow-down"></i> Transferred Out</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for player in gw_data.starting_xi %}
                                        {% if player.transfer_out %}
                                        <span class="badge bg-danger">{{ player.web_name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-success mb-2"><i class="fas fa-check-circle"></i> Selected Players</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for player in gw_data.starting_xi %}
                                    <span class="badge bg-success">{{ player.web_name }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            <!-- GW2-9: Optimized squads -->
            {% if weekly_data %}
                {% for gw_data in weekly_data %}
                    {% if gw_data.gw > 1 %}
                    <div class="tab-pane fade" id="gw{{ gw_data.gw }}" role="tabpanel">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-chart-line"></i> GW{{ gw_data.gw }} - Optimized Squad 
                                    {% if gw_data.status == 'Historical' %}
                                        <span class="badge bg-info ms-2">Historical</span>
                                    {% elif gw_data.status == 'Current' %}
                                        <span class="badge bg-success ms-2">Current</span>
                                    {% elif gw_data.status == 'Predicted' %}
                                        <span class="badge bg-warning ms-2">Predicted</span>
                                    {% endif %}
                                </h5>
                                <div class="search-field">
                                    <input type="search" class="form-control form-control-sm" id="gw{{ gw_data.gw }}Search" placeholder="Search players..." style="width: 200px;">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="gw{{ gw_data.gw }}Table">
                                        <thead>
                                            <tr>
                                                <th>Position</th>
                                                <th>Name</th>
                                                <th>Team</th>
                                                <th>Price</th>
                                                <th>GW{{ gw_data.gw }} xP</th>
                                                <th>GW{{ gw_data.gw }} Actual</th>
                                                <th>Diff</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for player in gw_data.starting_xi %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-primary">{{ player.position }}</span>
                                                </td>
                                                <td>
                                                    <strong>{{ player.name }}</strong>
                                                    {% if player.name == gw_data.captain_name %}
                                                        <span class="badge bg-warning ms-1">C</span>
                                                    {% endif %}
                                                    {% if player.name == gw_data.vice_captain_name %}
                                                        <span class="badge bg-info ms-1">V</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ player.team }}</td>
                                                <td>£{{ "%.1f"|format(player.price) }}M</td>
                                                <td>{{ "%.1f"|format(player.get('gw' + gw_data.gw|string + '_points', 0) or 0) }}</td>
                                                <td>{{ "%.1f"|format((player.actual_points|float) if player.actual_points else 0) }}</td>
                                                <td class="{% if (player.actual_points|float) > (player.get('gw' + gw_data.gw|string + '_points', 0)|float) %}text-success{% elif (player.actual_points|float) < (player.get('gw' + gw_data.gw|string + '_points', 0)|float) %}text-danger{% endif %}">
                                                    {{ "%.1f"|format((player.actual_points|float) - (player.get('gw' + gw_data.gw|string + '_points', 0)|float)) }}
                                                </td>
                                                <td><span class="badge bg-success">Starting XI</span></td>
                                                <td>
                                                    {% if player.name in gw_data.transfers_in %}
                                                        <span class="badge bg-success">IN</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            
                                            {% for player in gw_data.bench %}
                                            <tr class="table-secondary">
                                                <td>
                                                    <span class="badge bg-secondary">{{ player.position }}</span>
                                                </td>
                                                <td>
                                                    <strong>{{ player.name }}</strong>
                                                </td>
                                                <td>{{ player.team }}</td>
                                                <td>£{{ "%.1f"|format(player.price) }}M</td>
                                                <td>{{ "%.1f"|format(player.get('gw' + gw_data.gw|string + '_points', 0) or 0) }}</td>
                                                <td>{{ "%.1f"|format((player.actual_points|float) if player.actual_points else 0) }}</td>
                                                <td class="{% if (player.actual_points|float) > (player.get('gw' + gw_data.gw|string + '_points', 0)|float) %}text-success{% elif (player.actual_points|float) < (player.get('gw' + gw_data.gw|string + '_points', 0)|float) %}text-danger{% endif %}">
                                                    {{ "%.1f"|format((player.actual_points|float) - (player.get('gw' + gw_data.gw|string + '_points', 0)|float)) }}
                                                </td>
                                                <td><span class="badge bg-secondary">Bench</span></td>
                                                <td>
                                                    {% if player.name in gw_data.transfers_in %}
                                                        <span class="badge bg-success">IN</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transfer Details Panel for GW2+ -->
                        {% if gw_data.transfers_in or gw_data.transfers_out %}
                        <div class="row mt-3">
                            <!-- Transfer Details Panel -->
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-exchange-alt"></i> Transfer Details</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if gw_data.transfers_out %}
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <h6 class="text-danger mb-2"><i class="fas fa-arrow-down"></i> Transferred Out</h6>
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for player_out in gw_data.transfers_out %}
                                                    <span class="badge bg-danger">{{ player_out }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if gw_data.transfers_in %}
                                        <div class="row">
                                            <div class="col-12">
                                                <h6 class="text-success mb-2"><i class="fas fa-arrow-up"></i> Transferred In</h6>
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for player_in in gw_data.transfers_in %}
                                                    <span class="badge bg-success">{{ player_in }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Transfer Considerations Panel -->
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Transfer Considerations</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if gw_data.transfers_in and gw_data.transfers_out %}
                                            <h6 class="text-primary mb-2">Why These Transfers?</h6>
                                            <p class="small text-muted mb-3">
                                                Detailed analysis based on predicted points over the next 8 gameweeks, 
                                                considering transfer costs, squad value, and long-term benefits.
                                            </p>
                                            
                                            {% for i in range(gw_data.transfers_out|length) %}
                                                {% set player_out_name = gw_data.transfers_out[i] %}
                                                {% set player_in_name = gw_data.transfers_in[i] %}
                                                
                                                <!-- Get full player objects with analysis data -->
                                                {% set player_out = gw_data.transfers_out_players[i] if gw_data.transfers_out_players and i < gw_data.transfers_out_players|length else None %}
                                                {% set player_in = gw_data.transfers_in_players[i] if gw_data.transfers_in_players and i < gw_data.transfers_in_players|length else None %}
                                                
                                                <div class="mb-4 p-3 border-start border-primary border-3 ps-3">
                                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                                        <span class="badge bg-danger">{{ player_out_name }}</span>
                                                        <i class="fas fa-arrow-right text-muted mx-2"></i>
                                                        <span class="badge bg-success">{{ player_in_name }}</span>
                                                    </div>
                                                    
                                                    {% if player_out and player_in and player_out.transfer_analysis %}
                                                        {% set analysis = player_out.transfer_analysis %}
                                                        
                                                        <!-- 8-Week Predicted Points Analysis -->
                                                        <div class="row mb-3">
                                                            <div class="col-6">
                                                                <h6 class="text-danger small mb-1">{{ player_out_name }} - Next 8 GWs</h6>
                                                                <div class="d-flex flex-wrap gap-1 mb-2">
                                                                    {% for week_data in analysis.out_weekly_points %}
                                                                        <span class="badge bg-light text-dark" title="GW{{ week_data.gw }}: {{ "%.1f"|format(week_data.points) }} pts">
                                                                            GW{{ week_data.gw }}: {{ "%.1f"|format(week_data.points) }}
                                                                        </span>
                                                                    {% endfor %}
                                                                </div>
                                                                <div class="text-center">
                                                                    <strong class="text-danger">{{ "%.1f"|format(analysis.out_player_8week_total) }} pts</strong>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <h6 class="text-success small mb-1">{{ player_in_name }} - Next 8 GWs</h6>
                                                                <div class="d-flex flex-wrap gap-1 mb-2">
                                                                    {% for week_data in analysis.in_weekly_points %}
                                                                        <span class="badge bg-light text-dark" title="GW{{ week_data.gw }}: {{ "%.1f"|format(week_data.points) }} pts">
                                                                            GW{{ week_data.gw }}: {{ "%.1f"|format(week_data.points) }}
                                                                        </span>
                                                                    {% endfor %}
                                                                </div>
                                                                <div class="text-center">
                                                                    <strong class="text-success">{{ "%.1f"|format(analysis.in_player_8week_total) }} pts</strong>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Transfer Analysis Summary -->
                                                        <div class="alert alert-info mb-3">
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <small class="text-muted">Point Difference</small><br>
                                                    <strong class="{% if analysis.point_difference > 0 %}text-success{% else %}text-danger{% endif %}">
                                                        {{ "%.1f"|format(analysis.point_difference) }} pts
                                                    </strong>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Transfer Cost</small><br>
                                                    <strong class="{% if analysis.transfer_cost == 0 %}text-success{% else %}text-warning{% endif %}">
                                                        {% if analysis.transfer_cost == 0 %}
                                                            Free Transfer
                                                        {% else %}
                                                            {{ analysis.transfer_cost }} pts hit
                                                        {% endif %}
                                                    </strong>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Net Gain</small><br>
                                                    <strong class="{% if analysis.net_gain > 0 %}text-success{% else %}text-danger{% endif %}">
                                                        {{ "%.1f"|format(analysis.net_gain) }} pts
                                                    </strong>
                                                </div>
                                            </div>
                                        </div>
                                                        
                                                        <!-- Value Analysis -->
                                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <small class="text-muted">Price Difference</small><br>
                                                <strong class="{% if analysis.price_difference <= 0 %}text-success{% else %}text-warning{% endif %}">
                                                    £{{ "%.1f"|format(analysis.price_difference) }}M
                                                </strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">PPM Improvement</small><br>
                                                <strong class="{% if analysis.ppm_improvement > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    {{ "%.2f"|format(analysis.ppm_improvement) }}
                                                </strong>
                                            </div>
                                        </div>
                                                        
                                                        <!-- Transfer Recommendation -->
                                                        <div class="alert alert-{% if analysis.net_gain > 0 %}success{% elif analysis.point_difference > 0 %}warning{% else %}danger{% endif %} mb-2">
                                            <strong>Recommendation:</strong> {{ analysis.recommendation }}
                                        </div>
                                                        
                                                        <!-- Detailed Reasoning -->
                                                        <div class="small">
                                            <strong>Analysis:</strong> 
                                            <span class="{% if analysis.net_gain > 0 %}text-success{% elif analysis.point_difference > 0 %}text-warning{% else %}text-danger{% endif %}">
                                                Over the next 8 gameweeks ({{ analysis.analysis_period }}), {{ player_in_name }} is predicted to score 
                                                {{ "%.1f"|format(analysis.in_player_8week_total) }} points compared to {{ player_out_name }}'s 
                                                {{ "%.1f"|format(analysis.out_player_8week_total) }} points. This represents a 
                                                {{ "%.1f"|format(analysis.point_difference) }}-point improvement.
                                                
                                                {% if analysis.net_gain > 0 %}
                                                    {% if analysis.transfer_cost == 0 %}
                                                        This free transfer results in a net gain of 
                                                        {{ "%.1f"|format(analysis.net_gain) }} points over the analysis period.
                                                    {% else %}
                                                        Even with a {{ analysis.transfer_cost }}-point transfer hit, this results in a net gain of 
                                                        {{ "%.1f"|format(analysis.net_gain) }} points over the analysis period.
                                                    {% endif %}
                                                {% elif analysis.point_difference > 0 %}
                                                    {% if analysis.transfer_cost == 0 %}
                                                        This free transfer shows a net gain of 
                                                        {{ "%.1f"|format(analysis.point_difference) }} points over the analysis period.
                                                    {% else %}
                                                        However, the {{ analysis.transfer_cost }}-point transfer cost means this transfer shows a net loss of 
                                                        {{ "%.1f"|format(-analysis.net_gain) }} points, though it may still be justified by other factors.
                                                    {% endif %}
                                                {% else %}
                                                    This transfer shows a net loss of {{ "%.1f"|format(-analysis.net_gain) }} points over 8 gameweeks.
                                                {% endif %}
                                            </span>
                                        </div>
                                                    {% else %}
                                                        <!-- Fallback for when analysis data is not available -->
                                                        <div class="alert alert-warning mb-2">
                                            <small>
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>Analysis Unavailable:</strong> Detailed transfer analysis data is not available for this transfer.
                                            </small>
                                        </div>
                                                        
                                                        <div class="small">
                                            <strong>Basic Reasoning:</strong> 
                                            <span class="text-success">
                                                {{ player_in_name }} is expected to outperform {{ player_out_name }} over the next 8 gameweeks. 
                                                Even with a {{ gw_data.hits_points // (gw_data.transfers_in|length) if gw_data.transfers_in|length > 0 else 0 }}-point transfer hit, 
                                                this transfer should provide a net gain in the long term.
                                            </span>
                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                            
                                            <!-- Overall Transfer Summary -->
                                            {% if gw_data.hits_points < 0 %}
                                            <div class="alert alert-warning mt-3 mb-0">
                                                <small>
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    <strong>Overall Impact:</strong> These transfers cost {{ -gw_data.hits_points }} points in hits this gameweek, 
                                                    but the expected improvement over the next 8 gameweeks should justify the short-term cost.
                                                </small>
                                            </div>
                                            {% endif %}
                                        {% else %}
                                            <div class="text-center text-muted">
                                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                <p class="small mb-0">No transfers made this gameweek.</p>
                                                <p class="small">The current squad is optimal for this gameweek's fixtures.</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <!-- League Standings -->
        {% if standings %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-trophy"></i> League Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Gameweek</th>
                                        <th>GW Points</th>
                                        <th>Total Points</th>
                                        <th>GW Rank</th>
                                        <th>Overall Rank</th>
                                        <th>Transfers</th>
                                        <th>Transfer Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for standing in standings %}
                                    <tr>
                                        <td><strong>GW{{ standing.gameweek }}</strong></td>
                                        <td>{{ standing.gameweek_points }}</td>
                                        <td>{{ standing.total_points }}</td>
                                        <td>{{ standing.gameweek_rank or 'N/A' }}</td>
                                        <td>{{ standing.overall_rank or 'N/A' }}</td>
                                        <td>{{ standing.transfers_made }}</td>
                                        <td>{{ standing.transfer_cost }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle"></i> No Squad Data</h5>
            <p>Your squad data hasn't been synced yet. Click the "Sync Squad Data" button above to fetch your current and historical squads from FPL.</p>
        </div>
        {% endif %}
    {% endif %}
  </div>

  <!-- Refresh Progress Modal -->
  <div class="modal fade" id="refreshModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Refreshing Squad Data</h5>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p id="refreshMessage">Fetching latest squad data from FPL...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script>
  $(document).ready(function() {
      // Auto-refresh squad data on page load if we have a profile but no squad data
      {% if profile and not squad %}
      console.log('Auto-refreshing squad data on page load...');
      setTimeout(function() {
          refreshSquad();
      }, 500); // Small delay to ensure page is fully loaded
      {% endif %}
      
      $('#syncSquadDataBtn').on('click', function() {
          syncSquadData();
      });
      
      function syncSquadData() {
          $('#refreshModal').modal('show');
          $('#refreshMessage').text('Syncing all squad data from FPL (current + historical)...');
          
          // Redirect to the same page with sync_squad_data parameter
          window.location.href = '/squad-live?sync_squad_data=true';
      }
      
      // GW Tab Navigation
      let currentGw = 1;
      const totalGw = 9;
      
      // Previous GW button
      $('#prevGw').on('click', function() {
          if (currentGw > 1) {
              currentGw--;
              showGw(currentGw);
          }
      });
      
      // Next GW button
      $('#nextGw').on('click', function() {
          if (currentGw < totalGw) {
              currentGw++;
              showGw(currentGw);
          }
      });
      
      // GW tab clicks
      $('.nav-link[data-gw]').on('click', function() {
          const gw = parseInt($(this).data('gw'));
          currentGw = gw;
          showGw(gw);
      });
      
      function showGw(gw) {
          // Hide all GW content
          $('.tab-pane').removeClass('show active');
          $('.nav-link[data-gw]').removeClass('active');
          
          // Show selected GW content
          $(`#gw${gw}`).addClass('show active');
          $(`#gw${gw}-tab`).addClass('active');
          
          // Update navigation buttons
          $('#prevGw').prop('disabled', gw === 1);
          $('#nextGw').prop('disabled', gw === totalGw);
          
          // Update Squad Overview panel
          updateSquadOverview(gw);
          
          // Update URL hash to maintain state on refresh
          if (history.pushState) {
              history.pushState(null, null, `#gw${gw}`);
          } else {
              location.hash = `#gw${gw}`;
          }
      }
      
      function restoreTabFromUrl() {
          // Check if there's a hash in the URL
          const hash = window.location.hash;
          if (hash && hash.startsWith('#gw')) {
              const gw = parseInt(hash.substring(3));
              if (gw >= 1 && gw <= totalGw) {
                  showGw(gw);
                  return true;
              }
          }
          return false;
      }
      
      // Function to apply new transfer limit and rerun optimization
      function applyTransferLimit() {
          const maxTransfers = document.getElementById('maxTransfers').value;
          const applyButton = document.getElementById('applyTransfers');
          
          // Show loading state
          applyButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Optimizing...';
          applyButton.disabled = true;
          
          // Reload page with new transfer limit
          const currentUrl = new URL(window.location);
          currentUrl.searchParams.set('max_transfers', maxTransfers);
          
          // Show confirmation message
          const toast = document.createElement('div');
          toast.className = 'alert alert-info alert-dismissible fade show position-fixed';
          toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
          toast.innerHTML = `
              <strong>Optimizing Squad...</strong><br>
              Applying new transfer limit: ${maxTransfers} transfers per GW<br>
              <small>This will regenerate GW2-9 with proper FPL rule compliance.</small>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(toast);
          
          // Reload page after short delay to show message
          setTimeout(() => {
              window.location.href = currentUrl.toString();
          }, 1500);
      }
      
      // Function to update Squad Overview panel values based on selected GW
      function updateSquadOverview(gw) {
          if (gw === 1) {
              // GW1: Use actual squad data
              const squadValue = {{ squad|sum(attribute='price') if squad else 0 }};
              const formation = '{{ squad|selectattr("is_bench", "equalto", false)|selectattr("position", "equalto", "Goalkeeper")|list|length }}-{{ squad|selectattr("is_bench", "equalto", false)|selectattr("position", "equalto", "Defender")|list|length }}-{{ squad|selectattr("is_bench", "equalto", false)|selectattr("position", "equalto", "Midfielder")|list|length }}-{{ squad|selectattr("is_bench", "equalto", false)|selectattr("position", "equalto", "Forward")|list|length }}';
              const hits = '0 points';
              
              document.getElementById('topSquadValue').textContent = `£${squadValue.toFixed(1)}M`;
              document.getElementById('topSquadFormation').textContent = formation;
              document.getElementById('topSquadHits').textContent = hits;
              document.getElementById('topSquadTransfers').textContent = '0 IN, 0 OUT'; // Reset for GW1
          } else {
              // GW2-9: Use optimized squad data
              const gwData = weeklyData.find(data => data.gw === gw);
              if (gwData) {
                  const squadValue = gwData.squad_value || 0;
                  const formation = gwData.formation || 'Unknown';
                  const hits = gwData.hits_points < 0 ? `${-gwData.hits_points} points` : '0 points';
                  const transfersIn = gwData.transfers_in ? gwData.transfers_in.length : 0;
                  const transfersOut = gwData.transfers_out ? gwData.transfers_out.length : 0;
                  
                  document.getElementById('topSquadValue').textContent = `£${squadValue.toFixed(1)}M`;
                  document.getElementById('topSquadFormation').textContent = formation;
                  document.getElementById('topSquadHits').textContent = hits;
                  document.getElementById('topSquadTransfers').textContent = `${transfersIn} IN, ${transfersOut} OUT`;
              }
          }
      }

      // Initialize DataTables for all GW tables
      let gw1Table;
      let gwTables = {};
      
      // Make weekly data available to JavaScript
      const weeklyData = [
          {% for gw_data in weekly_data %}
              {
                  gw: {{ gw_data.gw }},
                  squad_value: {{ gw_data.squad_value or 0 }},
                  formation: '{{ gw_data.formation or "Unknown" }}',
                  hits_points: {{ gw_data.hits_points or 0 }}
              }{% if not loop.last %},{% endif %}
          {% endfor %}
      ];
      
      $(document).ready(function() {
          // Custom sorting function for Position column
          $.extend($.fn.dataTable.ext.type.order, {
              "position-pre": function(data) {
                  var positionOrder = {
                      'Goalkeeper': 1,
                      'Defender': 2,
                      'Midfielder': 3,
                      'Forward': 4,
                      'Bench': 5
                  };
                  return positionOrder[data] || 6;
              },
              "status-pre": function(data) {
                  // Status sorting: Bench first (lower priority), then Starting XI
                  // This will put Bench at the bottom when sorting Z-A
                  if (data.includes('Bench')) return 1;
                  if (data.includes('Starting XI')) return 2;
                  return 3;
              }
          });

          // Initialize DataTables and store references
          if ($('#gw1Table').length) {
              gw1Table = $('#gw1Table').DataTable({
                  "order": [[7, "desc"], [0, "asc"]], // First by Status (Z-A: Bench at bottom), then by Position
                  "paging": false, // Remove pagination
                  "searching": false, // Disable built-in search field since we have custom ones
                  "info": false, // Remove "Showing X of Y entries" info
                  "columnDefs": [
                      { "type": "status", "targets": 7 }, // Apply custom sorting to Status column
                      { "type": "position", "targets": 0 } // Apply custom sorting to Position column
                  ]
              });
          }

          {% for gw_data in weekly_data %}
              {% if gw_data.gw > 1 %}
                  if ($('#gw{{ gw_data.gw }}Table').length) {
                      gwTables[{{ gw_data.gw }}] = $('#gw{{ gw_data.gw }}Table').DataTable({
                          "order": [[7, "desc"], [0, "asc"]], // First by Status (Z-A: Bench at bottom), then by Position
                          "paging": false, // Remove pagination
                          "searching": false, // Disable built-in search field since we have custom ones
                          "info": false, // Remove "Showing X of Y entries" info
                          "columnDefs": [
                              { "type": "status", "targets": 7 }, // Apply custom sorting to Status column
                              { "type": "position", "targets": 0 } // Apply custom sorting to Position column
                          ]
                      });
                  }
              {% endif %}
          {% endfor %}

          // Add search functionality for GW1
          if ($('#gw1Search').length) {
              $('#gw1Search').on('keyup', function() {
                  if (gw1Table) {
                      gw1Table.search(this.value).draw();
                  }
              });
          }

          // Add search functionality for GW2-9
          {% for gw_data in weekly_data %}
              {% if gw_data.gw > 1 %}
                  if ($('#gw{{ gw_data.gw }}Search').length) {
                      $('#gw{{ gw_data.gw }}Search').on('keyup', function() {
                          if (gwTables[{{ gw_data.gw }}]) {
                              gwTables[{{ gw_data.gw }}].search(this.value).draw();
                          }
                      });
                  }
              {% endif %}
          {% endfor %}
      });

      // Initialize
      // Try to restore tab from URL hash, fallback to GW1
      if (!restoreTabFromUrl()) {
          showGw(1);
      }
      
      // Listen for hash changes (browser back/forward buttons)
      $(window).on('hashchange', function() {
          restoreTabFromUrl();
      });
  });
  </script>
</body>
</html>
