<!DOCTYPE html>
<html>
<head>
  <title>Account - FPLove</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{background:#f8f9fa}
    .card{box-shadow:0 2px 10px rgba(0,0,0,.08)}
  </style>
</head>
<body class="p-4">
  {% include '_navbar.html' %}

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-plus-circle"></i> Add New FPL Team</h4>
          </div>
          <div class="card-body">
            <form id="teamIdForm">
              <div class="mb-3">
                <label for="fplTeamId" class="form-label">FPL Team ID</label>
                <input type="number" class="form-control" id="fplTeamId" 
                       placeholder="Enter your FPL Team ID" required>
                <div class="form-text">
                  You can find your Team ID in the URL when you're on your team page in the FPL app or website.
                  It's the number after "entry/" in the URL.
                </div>
              </div>
              
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-plus"></i> Add Team
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> How to Find Your Team ID</h5>
          </div>
          <div class="card-body">
            <ol class="mb-0">
              <li>Go to <a href="https://fantasy.premierleague.com" target="_blank">fantasy.premierleague.com</a></li>
              <li>Log in to your account</li>
              <li>Click on "My Team"</li>
              <li>Look at the URL - it will look like:<br>
                  <code>https://fantasy.premierleague.com/entry/1234567/event/1</code></li>
              <li>The number <strong>1234567</strong> is your Team ID</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Existing Profiles - RUD Operations -->
    {% if profiles %}
    <div class="row mt-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-list"></i> Your FPL Teams</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Team ID</th>
                    <th>Team Name</th>
                    <th>Manager</th>
                    <th>Added</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for profile in profiles %}
                  <tr>
                    <td><strong>{{ profile.fpl_team_id }}</strong></td>
                    <td>{{ profile.team_name or 'N/A' }}</td>
                    <td>{{ profile.manager_name or 'N/A' }}</td>
                    <td>{{ profile.created_at.split(' ')[0] if profile.created_at else 'N/A' }}</td>
                    <td>
                      <button class="btn btn-sm btn-success sync-profile-btn" 
                              data-team-id="{{ profile.fpl_team_id }}" title="Refresh data from FPL">
                        <i class="fas fa-sync"></i> Refresh
                      </button>
                      <button class="btn btn-sm btn-danger delete-profile-btn" 
                              data-team-id="{{ profile.fpl_team_id }}" title="Remove this team">
                        <i class="fas fa-trash"></i> Remove
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <!-- No profiles yet message -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No FPL Teams Added Yet</h5>
            <p class="text-muted">Add your first FPL team using the form above to get started.</p>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  $(document).ready(function() {
      // Add Team form
      $('#teamIdForm').on('submit', function(e) {
          e.preventDefault();
          
          const fplTeamId = $('#fplTeamId').val();
          if (!fplTeamId) {
              showAlert('Please enter a Team ID', 'warning');
              return;
          }
          
          // Show loading state
          const submitBtn = $(this).find('button[type="submit"]');
          const originalText = submitBtn.html();
          submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Adding...').prop('disabled', true);
          
          $.ajax({
              url: '/api/account/save-team-id',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ fpl_team_id: parseInt(fplTeamId) }),
              success: function(response) {
                  if (response.success) {
                      showAlert('Team added successfully!', 'success');
                      $('#fplTeamId').val(''); // Clear the input
                      setTimeout(() => location.reload(), 1500);
                  } else {
                      showAlert('Error: ' + response.error, 'danger');
                  }
              },
              error: function() {
                  showAlert('Error adding team. Please try again.', 'danger');
              },
              complete: function() {
                  // Restore button state
                  submitBtn.html(originalText).prop('disabled', false);
              }
          });
      });
      
      // Refresh Profile buttons
      $('.sync-profile-btn').on('click', function() {
          const teamId = $(this).data('team-id');
          refreshTeamData(teamId);
      });
      
      // Remove Profile buttons
      $('.delete-profile-btn').on('click', function() {
          const teamId = $(this).data('team-id');
          if (confirm('Are you sure you want to remove this team?')) {
              removeTeam(teamId);
          }
      });
      
      function refreshTeamData(fplTeamId) {
          const btn = $(`.sync-profile-btn[data-team-id="${fplTeamId}"]`);
          const originalText = btn.html();
          btn.html('<i class="fas fa-spinner fa-spin"></i> Refreshing...').prop('disabled', true);
          
          $.ajax({
              url: '/api/account/sync-data',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ fpl_team_id: fplTeamId }),
              success: function(response) {
                  if (response.success) {
                      showAlert('Team data refreshed successfully!', 'success');
                      setTimeout(() => location.reload(), 1500);
                  } else {
                      showAlert('Error refreshing data: ' + response.error, 'danger');
                  }
              },
              error: function() {
                  showAlert('Error refreshing team data. Please try again.', 'danger');
              },
              complete: function() {
                  btn.html(originalText).prop('disabled', false);
              }
          });
      }
      
      function removeTeam(fplTeamId) {
          $.ajax({
              url: '/api/account/delete-profile',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ fpl_team_id: fplTeamId }),
              success: function(response) {
                  if (response.success) {
                      showAlert('Team removed successfully!', 'success');
                      setTimeout(() => location.reload(), 1500);
                  } else {
                      showAlert('Error: ' + response.error, 'danger');
                  }
              },
              error: function() {
                  showAlert('Error removing team. Please try again.', 'danger');
              }
          });
      }
      
      function showAlert(message, type) {
          const alertHtml = `
              <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                  ${message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
          `;
          $('.container').prepend(alertHtml);
      }
  });
  </script>
</body>
</html>
