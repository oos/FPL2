<!DOCTYPE html>
<html>
<head>
    <title>FPL Players - Expected Points (GW1-9)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand { 
            font-weight: bold; 
            color: #2c3e50 !important; 
        }
        .nav-link { 
            color: #34495e !important; 
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-link.active { 
            background-color: #3498db !important; 
            color: white !important; 
            border-radius: 5px;
            transform: scale(1.05);
        }
        .nav-link:hover { 
            color: #3498db !important; 
            transform: translateY(-2px);
        }
        h1 { 
            color: #2c3e50; 
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .position-badge { 
            font-size: 0.8em; 
            padding: 4px 8px; 
            border-radius: 12px; 
            color: white; 
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .gk { background-color: #dc3545; }
        .def { background-color: #007bff; }
        .mid { background-color: #28a745; }
        .fwd { background-color: #ffc107; color: #212529; }
        
        .position-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .table th { 
            white-space: normal !important; 
            word-wrap: break-word !important;
            max-width: none !important;
            font-size: 0.85em;
            padding: 8px 4px;
            text-align: center;
            vertical-align: middle;
            transition: background-color 0.3s ease;
        }
        .table th:hover {
            background-color: #e9ecef !important;
        }
        
        .table td { 
            vertical-align: middle; 
            font-size: 0.9em;
            padding: 6px 4px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Enhanced UI Animations and Effects */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        .scale-in {
            animation: scaleIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Enhanced Button Styles */
        .btn {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border: none;
            color: #212529;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
        }
        
        /* Enhanced dropdown styling for optgroups */
        .form-select optgroup {
            font-weight: bold;
            color: #495057;
            background-color: #f8f9fa;
        }
        
        .form-select option {
            padding: 8px 12px;
        }
        
        /* Keyboard shortcut tooltip for dropdown */
        .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        
        /* Filter Summary Styling */
        .filter-summary .alert {
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            font-weight: 500;
        }
        
        .filter-summary .alert i {
            color: #1976d2;
        }
        
        .filter-summary .text-muted {
            color: #546e7a !important;
        }
        
        .filter-summary .alert:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }
        
        /* Enhanced DataTables Styling */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin: 10px 0;
        }
        
        /* Ensure DataTables controls use full width */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            display: inline-block;
            width: 50%;
        }
        
        .dataTables_wrapper .dataTables_length {
            text-align: left;
        }
        
        .dataTables_wrapper .dataTables_filter {
            text-align: right;
        }
        
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            width: 100%;
            text-align: center;
        }
        
        /* Ensure DataTables cells maintain center alignment */
        .dataTables_wrapper .dataTable td,
        .dataTables_wrapper .dataTable th {
            text-align: center !important;
        }
        
        /* Force center alignment for all table elements */
        #playersTable td,
        #playersTable th,
        .table td,
        .table th {
            text-align: center !important;
        }
        
        /* Override any DataTables inline styles */
        .dataTables_wrapper table.dataTable td,
        .dataTables_wrapper table.dataTable th {
            text-align: center !important;
        }
        
        /* Make table full width */
        .table-responsive {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        #playersTable {
            width: 100% !important;
            margin: 0 !important;
            table-layout: fixed !important;
        }
        
        .dataTables_wrapper {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .dataTables_wrapper .dataTable {
            width: 100% !important;
            margin: 0 !important;
            table-layout: fixed !important;
        }
        
        /* Ensure column widths are respected */
        #playersTable th,
        #playersTable td {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        /* Allow name column to wrap if needed */
        #playersTable th:first-child,
        #playersTable td:first-child {
            white-space: normal !important;
            word-wrap: break-word !important;
        }
        
        /* Ensure table stretches to full container width */
        .container-fluid {
            padding-left: 15px !important;
            padding-right: 15px !important;
        }
        
        .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        .col-md-12 {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        /* Ensure main container uses full width */
        .main-content {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 15px !important;
        }
        
        /* Remove any max-width constraints */
        .container, .container-fluid {
            max-width: none !important;
        }
        
        /* Ensure table wrapper takes full width */
        .table-wrapper {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 5px;
            margin: 0 2px;
            transition: all 0.3s ease;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff !important;
            border-color: #007bff !important;
            color: white !important;
            transform: scale(1.1);
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #0056b3 !important;
            border-color: #0056b3 !important;
            color: white !important;
            transform: translateY(-2px);
        }
        
        /* Save & Load Views Section */
        .views-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .views-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .views-section h5 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .views-section .form-control,
        .views-section .form-select {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        
        .views-section .form-control:focus,
        .views-section .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            transform: scale(1.02);
        }
        
        /* Advanced Filters Panel */
        .advanced-filters-panel {
            display: none;
            background: white;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }
        /* Hide legacy filter panel to avoid duplication with header filters */
        .filters-section { display: none !important; }
        
        .filters-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .filters-section h5 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .filters-section .form-control,
        .filters-section .form-select {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        
        .filters-section .form-control:focus,
        .filters-section .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            transform: scale(1.02);
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
    </style>
</head>
<body class="p-4">
    {% include '_navbar.html' %}
    
    <div class="container-fluid main-content">
        <h1 class="text-center fade-in"><i class="fas fa-users"></i> FPL Players - Expected Points (GW1-9)</h1>
        
        <!-- Save & Load Views Section -->
        <div class="views-section slide-up">
            <h5><i class="fas fa-bookmark"></i> Save & Load Views</h5>
            <div class="row">
                <div class="col-md-4">
                    <label for="viewName" class="form-label">View Name:</label>
                    <input type="text" id="viewName" class="form-control" placeholder="Enter view name">
                </div>
                <div class="col-md-4">
                    <label for="loadView" class="form-label">Load View or Quick Sort:</label>
                    <select id="loadView" class="form-select">
                        <option value="">Select a view or sorting option...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button id="saveView" class="btn btn-success me-2">
                            <i class="fas fa-save"></i> Save View
                        </button>
                        <button id="loadViewBtn" class="btn btn-primary">
                            <i class="fas fa-folder-open"></i> Load View
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Filters Section -->
        <div class="filters-section slide-up">
            <h5><i class="fas fa-filter"></i> Enhanced Filters</h5>
            <div class="row mb-3">
                <div class="col-md-2">
                    <label for="positionFilter" class="form-label">Position:</label>
                    <select id="positionFilter" class="form-select">
                        <option value="">All Positions</option>
                        <option value="Goalkeeper">Goalkeeper</option>
                        <option value="Defender">Defender</option>
                        <option value="Midfielder">Midfielder</option>
                        <option value="Forward">Forward</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="teamFilter" class="form-label">Team:</label>
                    <select id="teamFilter" class="form-select">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="maxPriceFilter" class="form-label">Max Price:</label>
                    <input type="number" id="maxPriceFilter" class="form-control" placeholder="e.g., 12.5" step="0.1">
                </div>
                <div class="col-md-2">
                    <label for="minChanceFilter" class="form-label">Min Chance %:</label>
                    <input type="number" id="minChanceFilter" class="form-control" placeholder="e.g., 75" min="0" max="100">
                </div>
                <div class="col-md-2">
                    <label for="minPointsPerMillionFilter" class="form-label">Min Points/£:</label>
                    <input type="number" id="minPointsPerMillionFilter" class="form-control" placeholder="e.g., 50" step="0.1">
                </div>
                <div class="col-md-2">
                    <label for="minTotalPointsFilter" class="form-label">Min Total Points:</label>
                    <input type="number" id="minTotalPointsFilter" class="form-control" placeholder="e.g., 100">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-2">
                    <label for="minFormFilter" class="form-label">Min Form:</label>
                    <input type="number" id="minFormFilter" class="form-control" placeholder="e.g., 5.0" step="0.1">
                </div>
                <div class="col-md-2">
                    <label for="minOwnershipFilter" class="form-label">Min Ownership %:</label>
                    <input type="number" id="minOwnershipFilter" class="form-control" placeholder="e.g., 10" min="0" max="100">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button id="applyFilters" class="btn btn-primary me-2">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button id="clearFilters" class="btn btn-warning">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <!-- Sort buttons removed - now available in dropdown -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter Summary removed; info will be inline with search via DataTables DOM -->
        
        <!-- Inline top controls: info/search + Advanced Filters button -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted" id="playersInfoInline"></div>
            <div class="d-flex align-items-center gap-2">
                <input type="search" class="form-control" id="globalSearch" placeholder="Search players..." style="max-width: 260px;">
                <button id="toggleAdvancedFilters" class="btn btn-outline-secondary">Advanced Filters</button>
            </div>
        </div>

        <!-- Advanced Filters Panel (hidden by default) -->
        <div id="advancedFiltersPanel" class="advanced-filters-panel">
            <div class="row g-2">
                <div class="col-md-2">
                    <label class="form-label">Min GW1-3 Avg</label>
                    <input id="filter-avg13" type="text" class="form-control form-control-sm" placeholder=">=5.0">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max Price</label>
                    <input id="filter-adv-price" type="text" class="form-control form-control-sm" placeholder="<=7.5">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Ownership %</label>
                    <input id="filter-adv-own" type="text" class="form-control form-control-sm" placeholder=">=10%">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Form</label>
                    <input id="filter-adv-form" type="text" class="form-control form-control-sm" placeholder=">=5">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Points/£</label>
                    <input id="filter-adv-ppm" type="text" class="form-control form-control-sm" placeholder=">=50">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="clearAdvancedFilters" class="btn btn-sm btn-outline-secondary w-100">Clear</button>
                </div>
            </div>
        </div>

        <!-- Players Table -->
        <div class="table-responsive scale-in table-wrapper">
            <table id="playersTable" class="table table-striped table-hover">
                <thead>
                    <tr class="filters-row">
                        <th><input id="filter-name" type="text" class="form-control form-control-sm" placeholder="Search name"></th>
                        <th>
                            <select id="filter-position" class="form-select form-select-sm">
                                <option value="">All</option>
                                <option value="Goalkeeper">Goalkeeper</option>
                                <option value="Defender">Defender</option>
                                <option value="Midfielder">Midfielder</option>
                                <option value="Forward">Forward</option>
                            </select>
                        </th>
                        <th>
                            <select id="filter-team" class="form-select form-select-sm">
                                <option value="">All</option>
                            </select>
                        </th>
                        <th><input id="filter-price" type="text" class="form-control form-control-sm" placeholder="e.g. 7.0"></th>
                        <th><input id="filter-chance" type="text" class="form-control form-control-sm" placeholder=">=75"></th>
                        <th><input id="filter-ppm" type="text" class="form-control form-control-sm" placeholder=">=50"></th>
                        <th><input id="filter-total" type="text" class="form-control form-control-sm" placeholder=">=100"></th>
                        <th><input id="filter-form" type="text" class="form-control form-control-sm" placeholder=">=5"></th>
                        <th><input id="filter-own" type="text" class="form-control form-control-sm" placeholder=">=10%"></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <th>Position</th>
                        <th>Team</th>
                        <th>Price</th>
                        <th>Chance %</th>
                        <th>Points/£</th>
                        <th>Total Points</th>
                        <th>Form</th>
                        <th>Ownership %</th>
                        <th>GW1<br><small>Opp/FDR</small></th>
                        <th>GW2</th>
                        <th>GW3</th>
                        <th>GW4</th>
                        <th>GW5</th>
                        <th>GW6</th>
                        <th>GW7</th>
                        <th>GW8</th>
                        <th>GW9</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <script>
        $(document).ready(function() {
            let currentTable = null;
            
            // Utility function for consistent number formatting
            function formatNumber(value, decimals = 1) {
                if (value === null || value === undefined || value === '') {
                    return '0.0';
                }
                const num = parseFloat(value);
                if (isNaN(num)) {
                    return '0.0';
                }
                return num.toFixed(decimals);
            }
            
            // Use players data from template (like the original implementation)
            const playersData = {{ players|tojson }};
            console.log('Players data loaded from template:', playersData.length, 'players');
            console.log('Sample player:', playersData[0]);
            
            // Populate team filter dropdown
            const teams = [...new Set(playersData.map(p => p.team))].sort();
            teams.forEach(team => {
                $('#teamFilter').append(`<option value="${team}">${team}</option>`);
            });
            
            // Create default "Value + Points" view if it doesn't exist
            createDefaultValuePointsView();
            
            // Test dropdown population immediately
            console.log('Testing immediate dropdown population...');
            console.log('Dropdown element exists:', $('#loadView').length);
            console.log('Dropdown element:', $('#loadView')[0]);
            
            updateViewsDropdown();
            console.log('Immediate dropdown population complete. Options count:', $('#loadView option').length);
            console.log('Dropdown HTML:', $('#loadView').html());
            
            // Test manual option addition
            $('#loadView').append('<option value="test">TEST OPTION</option>');
            console.log('After manual addition. Options count:', $('#loadView option').length);
            
            // Remove test option to keep dropdown clean
            $('#loadView option[value="test"]').remove();
            
            // Initialize DataTable
            initializeDataTable();
            
            // Set up event handlers
            setupEventHandlers();
            
            // Dropdown will be updated after DataTable initialization
            
            // Handle window resize to maintain full width
            $(window).on('resize', function() {
                if (currentTable && currentTable.columns) {
                    currentTable.columns.adjust();
                    $('#playersTable').css('width', '100%');
                    $('.dataTables_wrapper').css('width', '100%');
                }
            });
            
            function forceCenterAlignment() {
                // Force center alignment for all table cells
                $('#playersTable td, #playersTable th').css('text-align', 'center');
            }
            
            function createDefaultValuePointsView() {
                console.log('Creating default value points view...');
                
                // Check if default view already exists
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                console.log('Current saved views:', savedViews);
                
                if (!savedViews['Best Value Players']) {
                    // Create default view with Points/£ + Total Points sorting
                    const defaultView = {
                        name: 'Best Value Players',
                        description: 'Points/£ + Total Points',
                        filters: {
                            position: '',
                            team: '',
                            maxPrice: '',
                            minChance: '',
                            minPointsPerMillion: '',
                            minTotalPoints: '',
                            minForm: '',
                            minOwnership: ''
                        },
                        sorting: [[5, 'desc'], [6, 'desc']], // Points/£ then Total Points
                        pageLength: 25,
                        search: '',
                        timestamp: new Date().toISOString()
                    };
                    
                    savedViews['Best Value Players'] = defaultView;
                    localStorage.setItem('fplPlayerViews', JSON.stringify(savedViews));
                    console.log('Created default "Best Value Players" view:', defaultView);
                } else {
                    console.log('Default view already exists');
                }
            }
            
            function initializeDataTable() {
                console.log('Initializing DataTable with', playersData.length, 'players');
                console.log('First player data:', playersData[0]);
                
                // Destroy existing table if it exists
                if (currentTable) {
                    currentTable.destroy();
                }
                
                currentTable = $('#playersTable').DataTable({
                    // custom top controls handled outside
                    dom: 'rt<"row mt-2"<"col-md-6"l><"col-md-6"p>>',
                    data: playersData,
                    columns: [
                        { 
                            data: 'name', 
                            className: 'text-center',
                            width: '12%',
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    return `<a href="/player/${row.id}" class="text-decoration-none">${data}</a>`;
                                }
                                return data;
                            }
                        },
                        { 
                            data: 'position',
                            className: 'text-center',
                            width: '8%',
                            render: function(data) {
                                const classes = {
                                    'Goalkeeper': 'gk',
                                    'Defender': 'def',
                                    'Midfielder': 'mid',
                                    'Forward': 'fwd'
                                };
                                return `<span class="position-badge ${classes[data] || ''}">${data}</span>`;
                            }
                        },
                        { 
                            data: 'team', 
                            className: 'text-center',
                            width: '8%',
                            render: function(data, type, row) {
                                if (type === 'display' && row.team_id) {
                                    return `<a href="/team/${row.team_id}" class="text-decoration-none">${data}</a>`;
                                }
                                return data;
                            }
                        },
                        { 
                            data: 'price', 
                            className: 'text-center',
                            width: '6%',
                            render: function(data) {
                                return '£' + formatNumber(data, 1) + 'M';
                            }
                        },
                        { 
                            data: 'chance_of_playing_next_round', 
                            className: 'text-center',
                            width: '6%',
                            render: function(data) {
                                return formatNumber(data, 1) + '%';
                            }
                        },
                        { 
                            data: 'points_per_million', 
                            className: 'text-center',
                            width: '8%',
                            render: function(data) {
                                return formatNumber(data, 1);
                            }
                        },
                        { 
                            data: 'total_points', 
                            className: 'text-center',
                            width: '8%',
                            render: function(data) {
                                return formatNumber(data, 1);
                            }
                        },
                        { 
                            data: 'form', 
                            className: 'text-center',
                            width: '6%',
                            render: function(data) {
                                return formatNumber(data, 1);
                            }
                        },
                        { 
                            data: 'ownership', 
                            className: 'text-center',
                            width: '6%',
                            render: function(data) {
                                return formatNumber(data, 1) + '%';
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw1_points, 1);
                                const opp = row.gw1_opp ? row.gw1_opp : '';
                                const fdr = row.gw1_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class="badge bg-${color}">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw2_points, 1);
                                const opp = row.gw2_opp ? row.gw2_opp : '';
                                const fdr = row.gw2_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw3_points, 1);
                                const opp = row.gw3_opp ? row.gw3_opp : '';
                                const fdr = row.gw3_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw4_points, 1);
                                const opp = row.gw4_opp ? row.gw4_opp : '';
                                const fdr = row.gw4_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw5_points, 1);
                                const opp = row.gw5_opp ? row.gw5_opp : '';
                                const fdr = row.gw5_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw6_points, 1);
                                const opp = row.gw6_opp ? row.gw6_opp : '';
                                const fdr = row.gw6_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw7_points, 1);
                                const opp = row.gw7_opp ? row.gw7_opp : '';
                                const fdr = row.gw7_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw8_points, 1);
                                const opp = row.gw8_opp ? row.gw8_opp : '';
                                const fdr = row.gw8_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            width: '4%',
                            render: function(row) {
                                const pts = formatNumber(row.gw9_points, 1);
                                const opp = row.gw9_opp ? row.gw9_opp : '';
                                const fdr = row.gw9_fdr;
                                const color = fdr <= 2 ? 'success' : (fdr === 3 ? 'warning' : 'danger');
                                const fdrBadge = fdr ? `<span class=\"badge bg-${color}\">${fdr}</span>` : '';
                                return `${pts}<br><small>${opp} ${fdrBadge}</small>`;
                            }
                        }
                    ],
                    order: [[6, 'desc']], // Sort by total points by default
                    pageLength: 25,
                    responsive: true,
                    scrollX: true,
                    initComplete: function() {
                        console.log('DataTable initialization complete');
                        
                        // Force center alignment after DataTables initializes
                        forceCenterAlignment();
                        
                        // Ensure table uses full width
                        $('#playersTable').css('width', '100%');
                        $('.dataTables_wrapper').css('width', '100%');
                        $('.dataTables_wrapper .dataTable').css('width', '100%');
                        
                        // Column widths are now fixed, no need to adjust
                        console.log('Fixed column widths applied successfully');
                        
                        // Hook up global search and simple info text
                        $('#globalSearch').on('keyup change', function(){
                            currentTable.search(this.value).draw();
                        });
                        $('#playersInfoInline').text(`Showing ${currentTable.page.info().recordsDisplay} of ${currentTable.page.info().recordsTotal} entries`);
                        currentTable.on('draw', function(){
                            const info = currentTable.page.info();
                            $('#playersInfoInline').text(`Showing ${info.start + 1} to ${info.end} of ${info.recordsDisplay} entries`);
                        });

                        // Populate team filter options
                        const teams = [...new Set(playersData.map(p => p.team))].sort();
                        teams.forEach(team => {
                            $('#filter-team').append(`<option value="${team}">${team}</option>`);
                        });

                        // Now that DataTable is ready, update the dropdown
                        updateViewsDropdown();
                        
                        // Initialize filter summary
                        updateFilterSummary();
                    }
                });
            }

            // Column filter bindings (simple contains/thresholds)
            $('#filter-name').on('keyup change', function(){ currentTable.column(0).search(this.value).draw(); });
            $('#filter-position').on('change', function(){ currentTable.column(1).search(this.value).draw(); });
            $('#filter-team').on('change', function(){ currentTable.column(2).search(this.value).draw(); });

            function applyNumericFilter(inputId, columnIndex, comparator) {
                $(inputId).on('keyup change', function(){
                    const val = this.value.trim();
                    // Remove prior header-scope numeric filter for this column
                    $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(fn => !(fn._scope === 'header' && fn._col === columnIndex));
                    if (!val) { currentTable.draw(); return; }
                    let op = '>='; let num = parseFloat(val.replace(/[^0-9.]/g, ''));
                    if (val.startsWith('<=')) op = '<='; else if (val.startsWith('<')) op = '<';
                    else if (val.startsWith('>=')) op = '>='; else if (val.startsWith('>')) op = '>';
                    const predicate = function(settings, data){
                        const cell = parseFloat((data[columnIndex]||'').toString().replace(/[^0-9.]/g,'')) || 0;
                        if (op === '>=') return cell >= num; if (op === '>') return cell > num;
                        if (op === '<=') return cell <= num; if (op === '<') return cell < num;
                        return true;
                    };
                    predicate._col = columnIndex; predicate._scope = 'header';
                    $.fn.dataTable.ext.search.push(predicate);
                    currentTable.draw();
                });
            }

            applyNumericFilter('#filter-price', 3);
            applyNumericFilter('#filter-chance', 4);
            applyNumericFilter('#filter-ppm', 5);
            applyNumericFilter('#filter-total', 6);
            applyNumericFilter('#filter-form', 7);
            applyNumericFilter('#filter-own', 8);

            // Advanced filters toggle and handlers
            $('#toggleAdvancedFilters').on('click', function(){
                $('#advancedFiltersPanel').slideToggle(150);
            });

            function addAdvancedNumericFilter(selector, fn) {
                $(selector).on('keyup change', function(){
                    const val = this.value.trim();
                    // Remove any prior advanced filter with the same id
                    $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(f => !(f._adv && f._id === selector));
                    if (!val) { currentTable.draw(); return; }
                    let op = '>='; let num = parseFloat(val.replace(/[^0-9.]/g, ''));
                    if (val.startsWith('<=')) op = '<='; else if (val.startsWith('<')) op = '<';
                    else if (val.startsWith('>=')) op = '>='; else if (val.startsWith('>')) op = '>';
                    const predicate = function(settings, data, dataIndex){
                        const row = currentTable.row(dataIndex).data();
                        const metric = fn(row);
                        if (op === '>=') return metric >= num; if (op === '>') return metric > num;
                        if (op === '<=') return metric <= num; if (op === '<') return metric < num;
                        return true;
                    };
                    predicate._adv = true; predicate._id = selector;
                    $.fn.dataTable.ext.search.push(predicate);
                    currentTable.draw();
                });
            }

            // GW1-3 average points
            addAdvancedNumericFilter('#filter-avg13', (r) => {
                const a = parseFloat(r.gw1_points || 0); const b = parseFloat(r.gw2_points || 0); const c = parseFloat(r.gw3_points || 0);
                return (a + b + c) / 3.0;
            });
            addAdvancedNumericFilter('#filter-adv-price', (r) => parseFloat(r.price || 0));
            addAdvancedNumericFilter('#filter-adv-own', (r) => parseFloat((r.ownership || '0').toString().replace('%','')));
            addAdvancedNumericFilter('#filter-adv-form', (r) => parseFloat(r.form || 0));
            addAdvancedNumericFilter('#filter-adv-ppm', (r) => parseFloat(r.points_per_million || 0));

            $('#clearAdvancedFilters').on('click', function(){
                $('#advancedFiltersPanel input').val('');
                $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(f => !f._adv);
                currentTable.draw();
            });
            
            function setupEventHandlers() {
                // Save view button
                $('#saveView').on('click', function() {
                    saveView();
                });
                
                // Load view button
                $('#loadViewBtn').on('click', function() {
                    loadView();
                });
                
                // Clear filters button
                $('#clearFilters').on('click', function() {
                    clearFilters();
                });
                
                // Dynamic filtering - apply filters automatically as user types/changes values
                $('#positionFilter, #teamFilter').on('change', function() {
                    applyFilters();
                });
                
                // Real-time filtering for numeric inputs with debouncing
                let filterTimeout;
                $('#maxPriceFilter, #minChanceFilter, #minPointsPerMillionFilter, #minTotalPointsFilter, #minFormFilter, #minOwnershipFilter').on('input', function() {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => {
                        applyFilters();
                    }, 300); // 300ms delay to avoid excessive filtering while typing
                });
                
                // Keyboard shortcut for Value + Points sorting (Ctrl+V)
                $(document).on('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'v') {
                        e.preventDefault();
                        $('#loadView').val('sort_value_points');
                        handleQuickSort('sort_value_points');
                        showNotification('Keyboard shortcut: Ctrl+V for Value + Points sorting', 'info');
                    }
                });
            }
            
            function saveView() {
                const viewName = $('#viewName').val().trim();
                if (!viewName) {
                    showNotification('Please enter a view name', 'info');
                    return;
                }
                
                // Check if DataTable is ready
                if (!currentTable) {
                    showNotification('DataTable not ready yet. Please wait a moment and try again.', 'error');
                    return;
                }
                
                // Get current sorting state
                const currentSorting = currentTable.order();
                let sortDescription = 'Default';
                
                // Determine sort description for better view identification
                if (currentSorting.length === 1) {
                    if (currentSorting[0][0] === 5) sortDescription = 'Points/£';
                    else if (currentSorting[0][0] === 6) sortDescription = 'Total Points';
                } else if (currentSorting.length === 2) {
                    if (currentSorting[0][0] === 5 && currentSorting[1][0] === 6) {
                        sortDescription = 'Points/£ + Total Points';
                    }
                }
                
                const view = {
                    name: viewName,
                    description: sortDescription,
                    filters: {
                        position: $('#positionFilter').val(),
                        team: $('#teamFilter').val(),
                        maxPrice: $('#maxPriceFilter').val(),
                        minChance: $('#minChanceFilter').val(),
                        minPointsPerMillion: $('#minPointsPerMillionFilter').val(),
                        minTotalPoints: $('#minTotalPointsFilter').val(),
                        minForm: $('#minFormFilter').val(),
                        minOwnership: $('#minOwnershipFilter').val()
                    },
                    sorting: currentSorting,
                    pageLength: currentTable.page.len(),
                    search: currentTable.search(),
                    timestamp: new Date().toISOString()
                };
                
                // Save to localStorage
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                savedViews[viewName] = view;
                localStorage.setItem('fplPlayerViews', JSON.stringify(savedViews));
                
                showNotification(`View "${viewName}" (${sortDescription}) saved successfully!`, 'success');
                $('#viewName').val('');
                updateViewsDropdown();
            }
            
            function loadView() {
                const viewName = $('#loadView').val();
                if (!viewName) {
                    showNotification('Please select a view or sorting option', 'info');
                    return;
                }
                
                // Handle quick sorting options
                if (viewName.startsWith('sort_')) {
                    handleQuickSort(viewName);
                    return;
                }
                
                // Handle saved views
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                const view = savedViews[viewName];
                
                if (!view) {
                    showNotification('View not found', 'info');
                    return;
                }
                
                // Apply filters
                $('#positionFilter').val(view.filters.position || '');
                $('#teamFilter').val(view.filters.team || '');
                $('#maxPriceFilter').val(view.filters.maxPrice || '');
                $('#minChanceFilter').val(view.filters.minChance || '');
                $('#minPointsPerMillionFilter').val(view.filters.minPointsPerMillion || '');
                $('#minTotalPointsFilter').val(view.filters.minTotalPoints || '');
                $('#minFormFilter').val(view.filters.minForm || '');
                $('#minOwnershipFilter').val(view.filters.minOwnership || '');
                
                // Apply filters to table
                applyFilters();
                
                // Apply sorting and other settings
                if (view.sorting) {
                    currentTable.order(view.sorting).draw();
                    forceCenterAlignment();
                }
                
                if (view.pageLength) {
                    currentTable.page.len(view.pageLength).draw();
                    forceCenterAlignment();
                }
                
                if (view.search) {
                    currentTable.search(view.search).draw();
                    forceCenterAlignment();
                }
                
                showNotification(`View "${viewName}" loaded successfully!`, 'success');
            }
            
            function handleQuickSort(sortType) {
                // Check if DataTable is ready
                if (!currentTable) {
                    showNotification('DataTable not ready yet. Please wait a moment and try again.', 'error');
                    return;
                }
                
                switch(sortType) {
                    case 'sort_points':
                        currentTable.order([6, 'desc']).draw();
                        forceCenterAlignment();
                        showNotification('Sorted by Total Points (High to Low)', 'success');
                        break;
                    case 'sort_value':
                        currentTable.order([5, 'desc']).draw();
                        forceCenterAlignment();
                        showNotification('Sorted by Points/£ (High to Low)', 'success');
                        break;
                    case 'sort_value_points':
                        currentTable.order([
                            [5, 'desc'],  // Points/£ column (index 5)
                            [6, 'desc']   // Total Points column (index 6)
                        ]).draw();
                        forceCenterAlignment();
                        showNotification('Sorted by Value + Points (Best Value First)', 'success');
                        break;
                    default:
                        showNotification('Unknown sorting option', 'error');
                }
                
                // Reset dropdown to default
                $('#loadView').val('');
            }
            
            function updateViewsDropdown() {
                console.log('updateViewsDropdown function called');
                console.log('Dropdown element at start:', $('#loadView').length);
                
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                const viewNames = Object.keys(savedViews);
                
                console.log('Updating dropdown with saved views:', savedViews);
                console.log('View names found:', viewNames);
                
                $('#loadView').empty().append('<option value="">Select a view or sorting option...</option>');
                console.log('Added default option. Options count:', $('#loadView option').length);
                
                // Add quick sorting options at the top
                $('#loadView').append('<optgroup label="Quick Sorting Options">');
                $('#loadView').append('<option value="sort_points">📊 Sort by Total Points (High to Low)</option>');
                $('#loadView').append('<option value="sort_value">💰 Sort by Points/£ (High to Low)</option>');
                $('#loadView').append('<option value="sort_value_points">🎯 Sort by Value + Points (Best Value First)</option>');
                $('#loadView').append('</optgroup>');
                console.log('Added quick sorting options. Options count:', $('#loadView option').length);
                
                // Add saved views if any exist
                if (viewNames.length > 0) {
                    $('#loadView').append('<optgroup label="Saved Views">');
                    viewNames.forEach(name => {
                        const view = savedViews[name];
                        const description = view.description || 'Default';
                        const timestamp = view.timestamp ? new Date(view.timestamp).toLocaleDateString() : '';
                        const displayText = `${name} (${description})${timestamp ? ' - ' + timestamp : ''}`;
                        $('#loadView').append(`<option value="${name}" title="${displayText}">${displayText}</option>`);
                    });
                    $('#loadView').append('</optgroup>');
                    console.log('Added saved views. Options count:', $('#loadView option').length);
                }
                
                console.log('Dropdown updated. Total options:', $('#loadView option').length);
                console.log('Final dropdown HTML:', $('#loadView').html());
            }
            
            function updateFilterSummary() {
                const position = $('#positionFilter').val();
                const team = $('#teamFilter').val();
                const maxPrice = parseFloat($('#maxPriceFilter').val()) || 0;
                const minChance = parseFloat($('#minChanceFilter').val()) || 0;
                const minPointsPerMillion = parseFloat($('#minPointsPerMillionFilter').val()) || 0;
                const minTotalPoints = parseFloat($('#minTotalPointsFilter').val()) || 0;
                const minForm = parseFloat($('#minFormFilter').val()) || 0;
                const minOwnership = parseFloat($('#minOwnershipFilter').val()) || 0;
                
                // Count filtered players
                let filteredCount = 0;
                const activeFilters = [];
                
                playersData.forEach(player => {
                    if (position && player.position !== position) return;
                    if (team && player.team !== team) return;
                    if (maxPrice && player.price > maxPrice) return;
                    if (minChance && player.chance_of_playing_next_round < minChance) return;
                    if (minPointsPerMillion && player.points_per_million < minPointsPerMillion) return;
                    if (minTotalPoints && player.total_points < minTotalPoints) return;
                    if (minForm && player.form < minForm) return;
                    if (minOwnership && player.ownership < minOwnership) return;
                    
                    filteredCount++;
                });
                
                // Update summary text
                if (filteredCount === playersData.length) {
                    $('#filterSummaryText').text(`Showing all ${playersData.length} players`);
                    $('#filterSummaryDetails').text('');
                } else {
                    $('#filterSummaryText').text(`Showing ${filteredCount} of ${playersData.length} players`);
                    
                    // Build filter details
                    if (position) activeFilters.push(`Position: ${position}`);
                    if (team) activeFilters.push(`Team: ${team}`);
                    if (maxPrice) activeFilters.push(`Max Price: £${maxPrice}M`);
                    if (minChance) activeFilters.push(`Min Chance: ${minChance}%`);
                    if (minPointsPerMillion) activeFilters.push(`Min Points/£: ${minPointsPerMillion}`);
                    if (minTotalPoints) activeFilters.push(`Min Total Points: ${minTotalPoints}`);
                    if (minForm) activeFilters.push(`Min Form: ${minForm}`);
                    if (minOwnership) activeFilters.push(`Min Ownership: ${minOwnership}%`);
                    
                    if (activeFilters.length > 0) {
                        $('#filterSummaryDetails').text(`Active filters: ${activeFilters.join(', ')}`);
                    } else {
                        $('#filterSummaryDetails').text('');
                    }
                }
            }
            
            function applyFilters() {
                const position = $('#positionFilter').val();
                const team = $('#teamFilter').val();
                const maxPrice = parseFloat($('#maxPriceFilter').val()) || 0;
                const minChance = parseFloat($('#minChanceFilter').val()) || 0;
                const minPointsPerMillion = parseFloat($('#minPointsPerMillionFilter').val()) || 0;
                const minTotalPoints = parseFloat($('#minTotalPointsFilter').val()) || 0;
                const minForm = parseFloat($('#minFormFilter').val()) || 0;
                const minOwnership = parseFloat($('#minOwnershipFilter').val()) || 0;
                
                // Clear any existing custom filters (remove header-scope and advanced-scope filters)
                $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(fn => !(fn._scope === 'panel' || fn._scope === 'header' || fn._adv));
                
                // Apply filters to DataTable
                currentTable.draw();
                forceCenterAlignment();
                
                // Custom filtering function
                const panelFilter = function(settings, data, dataIndex) {
                    const player = playersData[dataIndex];
                    
                    if (position && player.position !== position) return false;
                    if (team && player.team !== team) return false;
                    if (maxPrice && player.price > maxPrice) return false;
                    if (minChance && player.chance_of_playing_next_round < minChance) return false;
                    if (minPointsPerMillion && player.points_per_million < minPointsPerMillion) return false;
                    if (minTotalPoints && player.total_points < minTotalPoints) return false;
                    if (minForm && player.form < minForm) return false;
                    if (minOwnership && player.ownership < minOwnership) return false;
                    
                    return true;
                };
                panelFilter._scope = 'panel';
                $.fn.dataTable.ext.search.push(panelFilter);
                
                currentTable.draw();
                forceCenterAlignment();
                
                // Update filter summary
                updateFilterSummary();
            }
            
            function clearFilters() {
                $('#positionFilter').val('');
                $('#teamFilter').val('');
                $('#maxPriceFilter').val('');
                $('#minChanceFilter').val('');
                $('#minPointsPerMillionFilter').val('');
                $('#minTotalPointsFilter').val('');
                $('#minFormFilter').val('');
                $('#minOwnershipFilter').val('');
                
                // Clear custom filtering
                $.fn.dataTable.ext.search.pop();
                currentTable.draw();
                forceCenterAlignment();
                
                // Update filter summary
                updateFilterSummary();
                
                showNotification('All filters cleared!', 'info');
            }
            
            function showNotification(message, type) {
                const notification = $(`
                    <div class="notification ${type}">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                `);
                
                $('#notificationContainer').append(notification);
                
                // Show notification
                setTimeout(() => notification.addClass('show'), 100);
                
                // Hide and remove notification
                setTimeout(() => {
                    notification.removeClass('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        });
    </script>
</body>
</html>
