<!DOCTYPE html>
<html>
<head>
    <title>FPL Players - Expected Points (GW1-9)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand { 
            font-weight: bold; 
            color: #2c3e50 !important; 
        }
        .nav-link { 
            color: #34495e !important; 
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-link.active { 
            background-color: #3498db !important; 
            color: white !important; 
            border-radius: 5px;
            transform: scale(1.05);
        }
        .nav-link:hover { 
            color: #3498db !important; 
            transform: translateY(-2px);
        }
        h1 { 
            color: #2c3e50; 
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .position-badge { 
            font-size: 0.8em; 
            padding: 4px 8px; 
            border-radius: 12px; 
            color: white; 
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .gk { background-color: #dc3545; }
        .def { background-color: #007bff; }
        .mid { background-color: #28a745; }
        .fwd { background-color: #ffc107; color: #212529; }
        
        .position-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .table th { 
            white-space: normal !important; 
            word-wrap: break-word !important;
            max-width: 80px !important;
            font-size: 0.85em;
            padding: 8px 4px;
            text-align: center;
            vertical-align: middle;
            transition: background-color 0.3s ease;
        }
        .table th:hover {
            background-color: #e9ecef !important;
        }
        
        .table td { 
            vertical-align: middle; 
            font-size: 0.9em;
            padding: 6px 4px;
            transition: all 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Enhanced UI Animations and Effects */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        .scale-in {
            animation: scaleIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Enhanced Button Styles */
        .btn {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border: none;
            color: #212529;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
        }
        
        /* Enhanced DataTables Styling */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin: 10px 0;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 5px;
            margin: 0 2px;
            transition: all 0.3s ease;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff !important;
            border-color: #007bff !important;
            color: white !important;
            transform: scale(1.1);
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #0056b3 !important;
            border-color: #0056b3 !important;
            color: white !important;
            transform: translateY(-2px);
        }
        
        /* Save & Load Views Section */
        .views-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .views-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .views-section h5 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .views-section .form-control,
        .views-section .form-select {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        
        .views-section .form-control:focus,
        .views-section .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            transform: scale(1.02);
        }
        
        /* Enhanced Filters Section */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .filters-section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .filters-section h5 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .filters-section .form-control,
        .filters-section .form-select {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        
        .filters-section .form-control:focus,
        .filters-section .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
            transform: scale(1.02);
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
    </style>
</head>
<body class="p-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="fas fa-users"></i> FPL Tools</span>
            <div class="navbar-nav">
                <a class="nav-link" href="/">FDR Table</a>
                <a class="nav-link active" href="/players">Players</a>
                <a class="nav-link" href="/squad">Squad</a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid">
        <h1 class="text-center fade-in"><i class="fas fa-users"></i> FPL Players - Expected Points (GW1-9)</h1>
        
        <!-- Save & Load Views Section -->
        <div class="views-section slide-up">
            <h5><i class="fas fa-bookmark"></i> Save & Load Views</h5>
            <div class="row">
                <div class="col-md-4">
                    <label for="viewName" class="form-label">View Name:</label>
                    <input type="text" id="viewName" class="form-control" placeholder="Enter view name">
                </div>
                <div class="col-md-4">
                    <label for="loadView" class="form-label">Load Saved View:</label>
                    <select id="loadView" class="form-select">
                        <option value="">Select a saved view...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button id="saveView" class="btn btn-success me-2">
                            <i class="fas fa-save"></i> Save View
                        </button>
                        <button id="loadViewBtn" class="btn btn-primary">
                            <i class="fas fa-folder-open"></i> Load View
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Filters Section -->
        <div class="filters-section slide-up">
            <h5><i class="fas fa-filter"></i> Enhanced Filters</h5>
            <div class="row mb-3">
                <div class="col-md-2">
                    <label for="positionFilter" class="form-label">Position:</label>
                    <select id="positionFilter" class="form-select">
                        <option value="">All Positions</option>
                        <option value="Goalkeeper">Goalkeeper</option>
                        <option value="Defender">Defender</option>
                        <option value="Midfielder">Midfielder</option>
                        <option value="Forward">Forward</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="teamFilter" class="form-label">Team:</label>
                    <select id="teamFilter" class="form-select">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="maxPriceFilter" class="form-label">Max Price:</label>
                    <input type="number" id="maxPriceFilter" class="form-control" placeholder="e.g., 12.5" step="0.1">
                </div>
                <div class="col-md-2">
                    <label for="minChanceFilter" class="form-label">Min Chance %:</label>
                    <input type="number" id="minChanceFilter" class="form-control" placeholder="e.g., 75" min="0" max="100">
                </div>
                <div class="col-md-2">
                    <label for="minPointsPerMillionFilter" class="form-label">Min Points/£:</label>
                    <input type="number" id="minPointsPerMillionFilter" class="form-control" placeholder="e.g., 50" step="0.1">
                </div>
                <div class="col-md-2">
                    <label for="minTotalPointsFilter" class="form-label">Min Total Points:</label>
                    <input type="number" id="minTotalPointsFilter" class="form-control" placeholder="e.g., 100">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-2">
                    <label for="minFormFilter" class="form-label">Min Form:</label>
                    <input type="number" id="minFormFilter" class="form-control" placeholder="e.g., 5.0" step="0.1">
                </div>
                <div class="col-md-2">
                    <label for="minOwnershipFilter" class="form-label">Min Ownership %:</label>
                    <input type="number" id="minOwnershipFilter" class="form-control" placeholder="e.g., 10" min="0" max="100">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button id="applyFilters" class="btn btn-primary me-2">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button id="clearFilters" class="btn btn-warning">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button id="sortByPoints" class="btn btn-info me-2">
                            <i class="fas fa-sort-numeric-down"></i> Sort by Points
                        </button>
                        <button id="sortByValue" class="btn btn-info">
                            <i class="fas fa-sort-numeric-down"></i> Sort by Value
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Players Table -->
        <div class="table-responsive scale-in">
            <table id="playersTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Position</th>
                        <th>Team</th>
                        <th>Price</th>
                        <th>Chance %</th>
                        <th>Points/£</th>
                        <th>Total Points</th>
                        <th>Form</th>
                        <th>Ownership %</th>
                        <th>GW1</th>
                        <th>GW2</th>
                        <th>GW3</th>
                        <th>GW4</th>
                        <th>GW5</th>
                        <th>GW6</th>
                        <th>GW7</th>
                        <th>GW8</th>
                        <th>GW9</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
    
    <script>
        $(document).ready(function() {
            let currentTable = null;
            
            // Use players data from template (like the original implementation)
            const playersData = {{ players|tojson }};
            console.log('Players data loaded from template:', playersData.length, 'players');
            console.log('Sample player:', playersData[0]);
            
            // Populate team filter dropdown
            const teams = [...new Set(playersData.map(p => p.team))].sort();
            teams.forEach(team => {
                $('#teamFilter').append(`<option value="${team}">${team}</option>`);
            });
            
            // Initialize DataTable
            initializeDataTable();
            
            // Set up event handlers
            setupEventHandlers();
            
            // Update views dropdown
            updateViewsDropdown();
            
            function initializeDataTable() {
                console.log('Initializing DataTable with', playersData.length, 'players');
                console.log('First player data:', playersData[0]);
                
                // Destroy existing table if it exists
                if (currentTable) {
                    currentTable.destroy();
                }
                
                currentTable = $('#playersTable').DataTable({
                    data: playersData,
                    columns: [
                        { data: 'name' },
                        { 
                            data: 'position',
                            render: function(data) {
                                const classes = {
                                    'Goalkeeper': 'gk',
                                    'Defender': 'def',
                                    'Midfielder': 'mid',
                                    'Forward': 'fwd'
                                };
                                return `<span class="position-badge ${classes[data] || ''}">${data}</span>`;
                            }
                        },
                        { data: 'team' },
                        { data: 'price' },
                        { data: 'chance_of_playing_next_round' },
                        { data: 'points_per_million' },
                        { data: 'total_points' },
                        { data: 'form' },
                        { data: 'ownership' },
                        { data: 'gw1_points' },
                        { data: 'gw2_points' },
                        { data: 'gw3_points' },
                        { data: 'gw4_points' },
                        { data: 'gw5_points' },
                        { data: 'gw6_points' },
                        { data: 'gw7_points' },
                        { data: 'gw8_points' },
                        { data: 'gw9_points' }
                    ],
                    order: [[6, 'desc']], // Sort by total points by default
                    pageLength: 25,
                    responsive: true,
                    scrollX: true
                });
            }
            
            function setupEventHandlers() {
                // Save view button
                $('#saveView').on('click', function() {
                    saveView();
                });
                
                // Load view button
                $('#loadViewBtn').on('click', function() {
                    loadView();
                });
                
                // Apply filters button
                $('#applyFilters').on('click', function() {
                    applyFilters();
                });
                
                // Clear filters button
                $('#clearFilters').on('click', function() {
                    clearFilters();
                });
                
                // Sort buttons
                $('#sortByPoints').on('click', function() {
                    currentTable.order([6, 'desc']).draw();
                    showNotification('Sorted by Total Points (descending)', 'info');
                });
                
                $('#sortByValue').on('click', function() {
                    currentTable.order([5, 'desc']).draw();
                    showNotification('Sorted by Points per Million (descending)', 'info');
                });
            }
            
            function saveView() {
                const viewName = $('#viewName').val().trim();
                if (!viewName) {
                    showNotification('Please enter a view name', 'info');
                    return;
                }
                
                const view = {
                    name: viewName,
                    filters: {
                        position: $('#positionFilter').val(),
                        team: $('#teamFilter').val(),
                        maxPrice: $('#maxPriceFilter').val(),
                        minChance: $('#minChanceFilter').val(),
                        minPointsPerMillion: $('#minPointsPerMillionFilter').val(),
                        minTotalPoints: $('#minTotalPointsFilter').val(),
                        minForm: $('#minFormFilter').val(),
                        minOwnership: $('#minOwnershipFilter').val()
                    },
                    sorting: currentTable.order(),
                    pageLength: currentTable.page.len(),
                    search: currentTable.search()
                };
                
                // Save to localStorage
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                savedViews[viewName] = view;
                localStorage.setItem('fplPlayerViews', JSON.stringify(savedViews));
                
                showNotification(`View "${viewName}" saved successfully!`, 'success');
                $('#viewName').val('');
                updateViewsDropdown();
            }
            
            function loadView() {
                const viewName = $('#loadView').val();
                if (!viewName) {
                    showNotification('Please select a view to load', 'info');
                    return;
                }
                
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                const view = savedViews[viewName];
                
                if (!view) {
                    showNotification('View not found', 'info');
                    return;
                }
                
                // Apply filters
                $('#positionFilter').val(view.filters.position || '');
                $('#teamFilter').val(view.filters.team || '');
                $('#maxPriceFilter').val(view.filters.maxPrice || '');
                $('#minChanceFilter').val(view.filters.minChance || '');
                $('#minPointsPerMillionFilter').val(view.filters.minPointsPerMillion || '');
                $('#minTotalPointsFilter').val(view.filters.minTotalPoints || '');
                $('#minFormFilter').val(view.filters.minForm || '');
                $('#minOwnershipFilter').val(view.filters.minOwnership || '');
                
                // Apply filters to table
                applyFilters();
                
                // Apply sorting and other settings
                if (view.sorting) {
                    currentTable.order(view.sorting).draw();
                }
                
                if (view.pageLength) {
                    currentTable.page.len(view.pageLength).draw();
                }
                
                if (view.search) {
                    currentTable.search(view.search).draw();
                }
                
                showNotification(`View "${viewName}" loaded successfully!`, 'success');
            }
            
            function updateViewsDropdown() {
                const savedViews = JSON.parse(localStorage.getItem('fplPlayerViews') || '{}');
                const viewNames = Object.keys(savedViews);
                
                $('#loadView').empty().append('<option value="">Select a saved view...</option>');
                viewNames.forEach(name => {
                    $('#loadView').append(`<option value="${name}">${name}</option>`);
                });
            }
            
            function applyFilters() {
                const position = $('#positionFilter').val();
                const team = $('#teamFilter').val();
                const maxPrice = parseFloat($('#maxPriceFilter').val()) || 0;
                const minChance = parseFloat($('#minChanceFilter').val()) || 0;
                const minPointsPerMillion = parseFloat($('#minPointsPerMillionFilter').val()) || 0;
                const minTotalPoints = parseFloat($('#minTotalPointsFilter').val()) || 0;
                const minForm = parseFloat($('#minFormFilter').val()) || 0;
                const minOwnership = parseFloat($('#minOwnershipFilter').val()) || 0;
                
                // Apply filters to DataTable
                currentTable.draw();
                
                // Custom filtering function
                $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                    const player = playersData[dataIndex];
                    
                    if (position && player.position !== position) return false;
                    if (team && player.team !== team) return false;
                    if (maxPrice && player.price > maxPrice) return false;
                    if (minChance && player.chance_of_playing_next_round < minChance) return false;
                    if (minPointsPerMillion && player.points_per_million < minPointsPerMillion) return false;
                    if (minTotalPoints && player.total_points < minTotalPoints) return false;
                    if (minForm && player.form < minForm) return false;
                    if (minOwnership && player.ownership < minOwnership) return false;
                    
                    return true;
                });
                
                currentTable.draw();
                showNotification('Filters applied successfully!', 'success');
            }
            
            function clearFilters() {
                $('#positionFilter').val('');
                $('#teamFilter').val('');
                $('#maxPriceFilter').val('');
                $('#minChanceFilter').val('');
                $('#minPointsPerMillionFilter').val('');
                $('#minTotalPointsFilter').val('');
                $('#minFormFilter').val('');
                $('#minOwnershipFilter').val('');
                
                // Clear custom filtering
                $.fn.dataTable.ext.search.pop();
                currentTable.draw();
                
                showNotification('All filters cleared!', 'info');
            }
            
            function showNotification(message, type) {
                const notification = $(`
                    <div class="notification ${type}">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                `);
                
                $('#notificationContainer').append(notification);
                
                // Show notification
                setTimeout(() => notification.addClass('show'), 100);
                
                // Hide and remove notification
                setTimeout(() => {
                    notification.removeClass('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        });
    </script>
</body>
</html>
